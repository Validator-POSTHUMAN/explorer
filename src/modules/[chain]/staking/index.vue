<script lang="ts" setup>
import {
  useBaseStore,
  useBlockchain,
  useFormatter,
  useMintStore,
  useStakingStore,
  useTxDialog,
} from '@/stores';
import { computed } from '@vue/reactivity';
import { onMounted, ref } from 'vue';
import { Icon } from '@iconify/vue';
import type { Key, SlashingParam, Validator } from '@/types';
import { formatSeconds } from '@/libs/utils';

const staking = useStakingStore();
const base = useBaseStore();
const format = useFormatter();
const dialog = useTxDialog();
const chainStore = useBlockchain();
const mintStore = useMintStore();

const cache = JSON.parse(localStorage.getItem('avatars') || '{}');
const avatars = ref(cache || {});
const latest = ref({} as Record<string, number>);
const yesterday = ref({} as Record<string, number>);
const tab = ref('active');
const unbondList = ref([] as Validator[]);
const slashing = ref({} as SlashingParam);

onMounted(() => {
  staking.fetchUnbondingValdiators().then((res) => {
    unbondList.value = res.concat(unbondList.value);
  });
  staking.fetchInacitveValdiators().then((res) => {
    unbondList.value = unbondList.value.concat(res);
  });
  chainStore.rpc.getSlashingParams().then((res) => {
    slashing.value = res.params;
  });
});

async function fetchChange() {
  let page = 0;

  let height = Number(base.latest?.block?.header?.height || 0);
  if (height > 14400) {
    height -= 14400;
  } else {
    height = 1;
  }
  // voting power in 24h ago
  while (page < staking.validators.length && height > 0) {
    await base.fetchValidatorByHeight(height, page).then((x) => {
      x.validators.forEach((v) => {
        yesterday.value[v.pub_key.key] = Number(v.voting_power);
      });
    });
    page += 100;
  }

  page = 0;
  // voting power for now
  while (page < staking.validators.length) {
    await base.fetchLatestValidators(page).then((x) => {
      x.validators.forEach((v) => {
        latest.value[v.pub_key.key] = Number(v.voting_power);
      });
    });
    page += 100;
  }
}

const changes = computed(() => {
  const changes = {} as Record<string, number>;
  Object.keys(latest.value).forEach((k) => {
    const l = latest.value[k] || 0;
    const y = yesterday.value[k] || 0;
    changes[k] = l - y;
  });
  return changes;
});

const change24 = (key: Key) => {
  const txt = key.key;
  // const n: number = latest.value[txt];
  // const o: number = yesterday.value[txt];
  // // console.log( txt, n, o)
  // return n > 0 && o > 0 ? n - o : 0;
  return changes.value[txt];
};

const change24Text = (key?: Key) => {
  if (!key) return '';
  const v = change24(key);
  return v && v !== 0 ? format.showChanges(v) : '';
};

const change24Color = (key?: Key) => {
  if (!key) return '';
  const v = change24(key);
  if (v > 0) return 'text-success';
  if (v < 0) return 'text-error';
};

const calculateRank = function (position: number) {
  let sum = 0;
  for (let i = 0; i < position; i++) {
    sum += Number(staking.validators[i]?.delegator_shares);
  }
  const percent = sum / staking.totalPower;

  switch (true) {
    case tab.value === 'active' && percent < 0.33:
      return 'error';
    case tab.value === 'active' && percent < 0.67:
      return 'warning';
    default:
      return 'primary';
  }
};

const calculateBg = function (rank: string) {
  switch (true) {
    case rank === 'error':
      return 'bg-[#33583B]';
    case rank === 'warning':
      return 'bg-[#334358]';
    default:
      return 'bg-primary';
  }
};

const calculateText = function (rank: string) {
  switch (true) {
    case rank === 'error':
      return 'text-[#03F237]';
    case rank === 'warning':
      return 'text-[#03C6F2]';
    default:
      return 'text-primary';
  }
};

function isFeatured(
  endpoints: string[],
  who?: { website?: string; moniker: string }
) {
  if (!endpoints || !who) return false;
  return (
    endpoints.findIndex(
      (x) =>
        (who.website &&
          who.website
            ?.substring(0, who.website?.lastIndexOf('.'))
            .endsWith(x)) ||
        who?.moniker?.toLowerCase().search(x.toLowerCase()) > -1
    ) > -1
  );
}

const list = computed(() => {
  if (tab.value === 'active') {
    return staking.validators.map((x, i) => ({
      v: x,
      rank: calculateRank(i),
      logo: logo(x.description.identity),
    }));
  } else if (tab.value === 'featured') {
    const endpoint = chainStore.current?.endpoints?.rest?.map(
      (x) => x.provider
    );
    if (endpoint) {
      endpoint.push('ping');
      return staking.validators
        .filter((x) => isFeatured(endpoint, x.description))
        .map((x, i) => ({
          v: x,
          rank: 'primary',
          logo: logo(x.description.identity),
        }));
    }
    return [];
  }
  return unbondList.value.map((x, i) => ({
    v: x,
    rank: 'primary',
    logo: logo(x.description.identity),
  }));
});

const fetchAvatar = (identity: string) => {
  // fetch avatar from keybase
  return new Promise<void>((resolve) => {
    staking
      .keybase(identity)
      .then((d) => {
        if (Array.isArray(d.them) && d.them.length > 0) {
          const uri = String(d.them[0]?.pictures?.primary?.url).replace(
            'https://s3.amazonaws.com/keybase_processed_uploads/',
            ''
          );

          avatars.value[identity] = uri;
          resolve();
        } else throw new Error(`failed to fetch avatar for ${identity}`);
      })
      .catch((error) => {
        // console.error(error); // uncomment this if you want the user to see which avatars failed to load.
        resolve();
      });
  });
};

const loadAvatar = (identity: string) => {
  // fetches avatar from keybase and stores it in localStorage
  fetchAvatar(identity).then(() => {
    localStorage.setItem('avatars', JSON.stringify(avatars.value));
  });
};

const loadAvatars = () => {
  // fetches all avatars from keybase and stores it in localStorage
  const promises = staking.validators.map((validator) => {
    const identity = validator.description?.identity;

    // Here we also check whether we haven't already fetched the avatar
    if (identity && !avatars.value[identity]) {
      return fetchAvatar(identity);
    } else {
      return Promise.resolve();
    }
  });

  Promise.all(promises).then(() =>
    localStorage.setItem('avatars', JSON.stringify(avatars.value))
  );
};

const logo = (identity?: string) => {
  if (!identity || !avatars.value[identity]) return '';
  const url = avatars.value[identity] || '';
  return url.startsWith('http')
    ? url
    : `https://s3.amazonaws.com/keybase_processed_uploads/${url}`;
};

let height_in_24h = ref(0);
base.$subscribe((_, s) => {
  if (Number(s.earlest.block.header.height) !== height_in_24h.value) {
    height_in_24h.value = Number(s.earlest.block.header.height);
    fetchChange();
  }
});
//:style="`--value:${mintStore.inflation}`"
loadAvatars();
</script>
<template>
  <div class="flex flex-row px-2 gap-4">
    <div class="flex flex-col border-8 px-2 py-4 border-[#222226] rounded-lg gap-4 bg-black bg-opacity-50 fixed">
      <div class="flex flex-row items-center">
        <div
          class="radial-progress text-[#3FB6A8]"
          :style="`--value:70`"
          role="progressbar"
        >
          <div class="p-4 rounded-full flex items-center justify-center">
            <img
              src="@/assets/staking/inflation.svg"
              class="object-contain"
              alt="image"
            />
          </div>
        </div>
        <div class="border-2 border-l-0 rounded-l-none -ml-4 border-[#222226] px-8 py-2 rounded-lg">
          <div class="uppercase text-[#71FFB8]">
            {{ $t('staking.inflation') }}
          </div>
          <div class="font-bold text-white">
            {{ format.percent(mintStore.inflation) }}
          </div>
        </div>
      </div>
      <div class="flex flex-row items-center">
        <div
          class="radial-progress text-[#3FB6A8]"
          :style="`--value:70`"
          role="progressbar"
        >
          <div class="p-4 rounded-full flex items-center justify-center">
            <img
              src="@/assets/staking/unbonding-time.svg"
              class="object-contain"
              alt="image"
            />
          </div>
        </div>
        <div class="border-2 border-l-0 rounded-l-none -ml-4 border-[#222226] px-8 py-2 rounded-lg">
          <div class="uppercase text-[#71FFB8]">
            {{ $t('staking.unbonding_time') }}
          </div>
          <div class="font-bold text-white">
            70%
          </div>
        </div>
      </div>
      <div class="flex flex-row items-center">
        <div
          class="radial-progress text-[#3FB6A8]"
          :style="`--value:11`"
          role="progressbar"
        >
          <div class="p-4 rounded-full flex items-center justify-center">
            <img
              src="@/assets/staking/apr.svg"
              class="object-contain"
              alt="image"
            />
          </div>
        </div>
        <div class="border-2 border-l-0 rounded-l-none -ml-4 border-[#222226] px-8 py-2 rounded-lg">
          <div class="uppercase text-[#71FFB8]">
            APR
          </div>
          <div class="font-bold text-white">
            11%
          </div>
        </div>
      </div>
      <div class="flex flex-row items-center">
        <div
          class="radial-progress text-[#3FB6A8]"
          :style="`--value:11`"
          role="progressbar"
        >
          <div class="p-4 rounded-full flex items-center justify-center">
            <img
              src="@/assets/staking/hard-slashing.svg"
              class="object-contain"
              alt="image"
            />
          </div>
        </div>
        <div class="border-2 border-l-0 rounded-l-none -ml-4 border-[#222226] px-8 py-2 rounded-lg">
          <div class="uppercase text-[#71FFB8]">
            hard slashing
          </div>
          <div class="font-bold text-white">
            11%
          </div>
        </div>
      </div>
      <div class="flex flex-row items-center">
        <div
          class="radial-progress text-[#3FB6A8]"
          :style="`--value:11`"
          role="progressbar"
        >
          <div class="p-4 rounded-full flex items-center justify-center">
            <img
              src="@/assets/staking/soft-slashing.svg"
              class="object-contain"
              alt="image"
            />
          </div>
        </div>
        <div class="border-2 border-l-0 rounded-l-none -ml-4 border-[#222226] px-8 py-2 rounded-lg">
          <div class="uppercase text-[#71FFB8]">
            soft slashing
          </div>
          <div class="font-bold text-white">
            11%
          </div>
        </div>
      </div>
    </div>
    <div class="ml-[20rem]">

    </div>
    <div class="flex-1">
      <div class="flex items-center justify-between py-1">
        <div class="tabs tabs-boxed bg-transparent">
          <a
            class="tab text-white px-8"
            :class="{ 'tab-active': tab === 'featured' }"
            @click="tab = 'featured'"
            >{{ $t('staking.popular') }}</a
          >
          <a
            class="tab text-white px-8"
            :class="{ 'tab-active': tab === 'active' }"
            @click="tab = 'active'"
            >{{ $t('staking.active') }}</a
          >
          <a
            class="tab text-white px-8"
            :class="{ 'tab-active': tab === 'inactive' }"
            @click="tab = 'inactive'"
            >{{ $t('staking.inactive') }}</a
          >
          <a
            class="tab text-white px-8"
            :class="{ 'tab-active': tab === 'jailed' }"
            @click="tab = 'jailed'"
            >{{ $t('staking.jailed') }}</a
          >
        </div>

        <!-- <div class="text-lg font-semibold">
          {{ list.length }}/{{ staking.params.max_validators }}
        </div> -->
      </div>

      <div class="bg-[#141415] px-4 pt-3 pb-4 rounded shadow">
        <div class="overflow-x-auto">
          <table class="table staking-table w-full">
            <thead>
              <tr>
                <th
                  scope="col"
                  class="uppercase text-[#686868]"
                  style="width: 3rem; position: relative"
                >
                  {{ $t('staking.rank') }}
                </th>
                <th scope="col" class="uppercase text-[#686868]">
                  {{ $t('staking.validator') }}
                </th>
                <th scope="col" class="text-right uppercase text-[#686868]">
                  {{ $t('staking.voting_power') }}
                </th>
                <th scope="col" class="text-right uppercase text-[#686868]">
                  {{ $t('staking.24h_changes') }}
                </th>
                <th scope="col" class="text-right uppercase text-[#686868]">
                  {{ $t('staking.commission') }}
                </th>
                <th scope="col" class="text-center uppercase text-[#686868]">
                  {{ $t('staking.actions') }}
                </th>
              </tr>
            </thead>
            <tbody>
              <tr
                v-for="({ v, rank, logo }, i) in list"
                :key="v.operator_address"
                class="hover:bg-[#242424]"
              >
                <!-- 👉 rank -->
                <td>
                  <div
                    class="text-xs truncate relative px-2 py-1 rounded-full w-fit"
                    :class="`${calculateText(rank)}`"
                  >
                    <span
                      class="inset-x-0 inset-y-0 opacity-50 absolute"
                      :class="`${calculateBg(rank)}`"
                    ></span>
                    {{ i + 1 }}
                  </div>
                </td>
                <!-- 👉 Validator -->
                <td>
                  <div
                    class="flex items-center overflow-hidden"
                    style="max-width: 300px"
                  >
                    <div class="avatar mr-4 relative w-8 h-8 rounded-full">
                      <div
                        class="w-8 h-8 rounded-full bg-gray-400 absolute opacity-10"
                      ></div>
                      <div class="w-8 h-8 rounded-full">
                        <img
                          v-if="logo"
                          :src="logo"
                          class="object-contain"
                          @error="
                            (e) => {
                              const identity = v.description?.identity;
                              if (identity) loadAvatar(identity);
                            }
                          "
                        />
                        <Icon
                          v-else
                          class="text-3xl"
                          :icon="`mdi-help-circle-outline`"
                        />
                      </div>
                    </div>

                    <div class="flex flex-col">
                      <span
                        class="text-sm text-[#FFFFFF] dark:invert whitespace-nowrap overflow-hidden"
                      >
                        <RouterLink
                          :to="{
                            name: 'chain-staking-validator',
                            params: {
                              validator: v.operator_address,
                            },
                          }"
                          class="font-weight-medium"
                        >
                          {{ v.description?.moniker }}
                        </RouterLink>
                      </span>
                      <span class="text-xs text-[#FFFFFF]">{{
                        v.description?.website || v.description?.identity || '-'
                      }}</span>
                    </div>
                  </div>
                </td>

                <!-- 👉 Voting Power -->
                <td class="text-right">
                  <div class="flex flex-col">
                    <h6
                      class="text-sm font-weight-medium whitespace-nowrap text-[#FFFFFF]"
                    >
                      {{
                        format.formatToken(
                          {
                            amount: parseInt(v.tokens).toString(),
                            denom: staking.params.bond_denom,
                          },
                          true,
                          '0,0'
                        )
                      }}
                    </h6>
                    <span class="text-xs text-[#FFFFFF]">{{
                      format.calculatePercent(
                        v.delegator_shares,
                        staking.totalPower
                      )
                    }}</span>
                  </div>
                </td>
                <!-- 👉 24h Changes -->
                <td
                  class="text-right text-xs"
                  :class="change24Color(v.consensus_pubkey)"
                >
                  {{ change24Text(v.consensus_pubkey) }}
                </td>
                <!-- 👉 commission -->
                <td class="text-right text-xs text-[#FFFFFF]">
                  {{
                    format.formatCommissionRate(
                      v.commission?.commission_rates?.rate
                    )
                  }}
                </td>
                <!-- 👉 Action -->
                <td class="text-center">
                  <div
                    v-if="v.jailed"
                    class="badge badge-error gap-2 text-white"
                  >
                    {{ $t('staking.jailed') }}
                  </div>
                  <label
                    v-else
                    for="delegate"
                    class="btn btn-xs bg-[#323232] hover:bg-[#2B3936] rounded-sm capitalize"
                    @click="
                      dialog.open('delegate', {
                        validator_address: v.operator_address,
                      })
                    "
                    >{{ $t('account.btn_delegate') }}</label
                  >
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="divider"></div>
        <div class="flex flex-row items-center">
          <div
            class="text-xs truncate relative py-2 px-4 rounded-md w-fit text-error mr-2"
          >
            <span
              class="inset-x-0 inset-y-0 opacity-10 absolute bg-error"
            ></span>
            {{ $t('staking.top') }} 33%
          </div>
          <div
            class="text-xs truncate relative py-2 px-4 rounded-md w-fit text-warning"
          >
            <span
              class="inset-x-0 inset-y-0 opacity-10 absolute bg-warning"
            ></span>
            {{ $t('staking.top') }} 67%
          </div>
          <div class="text-xs hidden md:!block pl-2">
            {{ $t('staking.description') }}
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<route>
  {
    meta: {
      i18n: 'staking',
      order: 3
    }
  }
</route>

<style>
.staking-table.table :where(th, td) {
  padding: 8px 5px;
  background: transparent;
}
</style>

<style>
.radial-progress::before {
  stroke-linecap: butt !important; /* Делаем углы острыми */
}
</style>
